---
title: nginx内存对齐
date: 2016-09-30 21:50:57
tags:
    - Nginx
    - C
---

最近在看`Nginx`的源代码，阅读其有关内存池实现的时候发现下面一段代码

```
if (align) {
	m = ngx_align_ptr(m, NGX_ALIGNMENT);
}
```

这段代码的意图很明显，就是将指针`m`按照`NGX_ALIGNMENT`大小进行对齐，那么它是如何进行对齐的呢？关键就在`ngx_align_ptr`，它其实是个宏，定义如下：

```
#define ngx_align_ptr(p, a)                                                   \
    (u_char *) (((uintptr_t) (p) + ((uintptr_t) a - 1)) & ~((uintptr_t) a - 1))
```

我刚看到这个宏的时候觉得很神奇，完全不知道它进行内存对齐的原理是什么。于是打算人肉运行一下这段代码，看能不能发现里面的玄机。

首先类型转换都去掉，这样代码能看的清楚一点：

```
(p + (a - 1)) & ~(a-1)
```

在进行内存的对齐的时候，一般都是将地址按`2`的幂进行对齐，也就是说`a`的末尾必然由0组成。假设有`N`个0，那么将`a`减去一后，就得到了一个末尾有`N`个`1`其他位都是`0`的数，再取反的话就变成了末尾有`N`个0，其他位都是`1`的数。那么再将这个数与任何数相与都将把被与数的最后`N`位变成`0`而其他位置不变，而这个数正是`a`的整数倍。那么加上`a-1`的目的是什么呢？很明显是为了最后得到的数要比`p`大，不然后的话，分配的内存就可能占用了别的已分配空间。

另外上面在进行运算之前将所有的变量都转换成了`uintptr_t`类型，该类型本质上也是个整型，但是该整型的大小能够安全的容纳指针变量，相比于直接用整数类型而言更加具有可移植性和安全性。

（完）